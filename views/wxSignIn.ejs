<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=0">
    <title>登录</title>
    <!-- 引入 WeUI -->
    <link rel="stylesheet" href="https://res.wx.qq.com/open/libs/weui/1.1.2/weui.min.css"/>
    <script src="//cdn1.lncld.net/static/js/2.5.0/av-min.js"></script>

</head>
<body ontouchstart>
<div class="weui-cells__title">汇邻优店</div>
<div class="weui-cells weui-cells_form">
    <div class="weui-cell">
        <div class="weui-cell__hd">
            <label class="weui-label">手机号</label>
        </div>
        <div class="weui-cell__bd">
            <input id="phone" class="weui-input" type="tel" placeholder="请输入手机号">
        </div>
    </div>
    <div class="weui-cell weui-cell_vcode">
        <div class="weui-cell__hd">
            <label class="weui-label">手机号</label>
        </div>
        <div class="weui-cell__bd">
            <input class="weui-input" type="tel" placeholder="请输入手机号">
        </div>
        <div class="weui-cell__ft">
            <a href="javascript:;" class="weui-vcode-btn">获取验证码</a>
        </div>
    </div>
    <div class="weui-cell weui-cell_vcode">
        <div class="weui-cell__hd"><label class="weui-label">验证码</label></div>
        <div class="weui-cell__bd">
            <input class="weui-input" type="number" placeholder="请输入验证码"/>
        </div>
        <div class="weui-cell__ft">
            <img class="weui-vcode-img" src="./images/vcode.jpg" />
        </div>
    </div>

    <div class="weui-cell">
        <div class="weui-cell__hd"><label class="weui-label">验证码</label></div>
        <div class="weui-cell__bd">
            <input id = "password" class="weui-input" type="password"  placeholder="请输入密码"/>
        </div>
    </div>
</div>

<div class="weui-btn-area">
    <a class="weui-btn weui-btn_primary"  id="showTooltips">登录</a>
</div>
</body>
<script type="text/javascript">
    var APP_ID = 'K5Rltwmfnxd5pYjMsOFFL0kT-gzGzoHsz';
    var APP_KEY = 'UseC5jvqLT7TIiQWI8nRPmEl';
    AV.init({
        appId: APP_ID,
        appKey: APP_KEY
    });

    var loginBtn = document.getElementById("showTooltips")
    var phone = document.getElementById("phone")
    var password = document.getElementById('password')
    var openid = "<%=openid%>"
    var accessToken = "<%=accessToken%>"
    var unionid = "<%=unionid%>"
    var expires_in = "<%=expires_in%>"

    var authData = {
        "openid": unionid,
        "access_token": accessToken,
        "expires_at": Date.parse(expires_in),
    }
    var platform = 'weixin'

    loginBtn.onclick = function () {
        AV.User.signUpOrlogInWithMobilePhone(phone.value, password.value).then((user) => {
            alert(authData)
            return AV.User.associateWithAuthData(user, platform, authData)
        }).then((user) => {
            if(user) {
                user.set('openid', openid)
                return user.save()
            }
            return null
        }).then((loginedUser) => {

            window.location.href = "/wxProfile?openid=" + openid

        }).catch((error) => {
            alert("手机号没有注册")
        })

    }
</script>
</html>